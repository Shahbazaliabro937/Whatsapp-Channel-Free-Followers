<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Channel Review Portal</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set Inter font as default and apply a clean background */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #e5e7eb; /* Light gray background */
        }
        /* Define a core color palette for a professional look */
        .primary-bg { background-color: #1f2937; } /* Dark Gray */
        .primary-text { color: #1f2937; }
        .accent-bg { background-color: #10b981; } /* Emerald Green for action */
        .card { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .input-focus:focus { border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        .main-container {
            min-height: calc(100vh - 8rem); /* Adjust for header and footer height */
            padding-bottom: 2rem;
        }
    </style>
</head>
<body>

    <!-- 1. Navigation Header -->
    <nav class="primary-bg text-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold tracking-wider">Channel Review Studio</span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Nav Links -->
                    <!-- Submission button will now navigate to #submission -->
                    <a href="#submission" class="text-sm font-medium hover:text-gray-300 transition duration-150">
                        Submission
                    </a>
                    <!-- Admin button will now navigate to #admin -->
                    <a id="admin-link-btn" href="#admin" class="hidden text-sm font-medium text-yellow-300 hover:text-yellow-400 transition duration-150">
                        Admin Panel
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 2. Main Content Container -->
    <div id="app" class="main-container flex flex-col items-center pt-8">
        <div class="w-full max-w-4xl bg-white rounded-lg p-6 card">

            <!-- Authentication Status and User ID -->
            <div id="auth-status" class="mb-6 p-4 bg-gray-100 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center text-sm border-l-4 border-gray-400">
                <p id="user-info" class="text-gray-600 mb-2 sm:mb-0">Your Status: <span class="font-semibold text-gray-600">Loading...</span></p>
            </div>

            <!-- Submission Form View -->
            <div id="submission-view" class="space-y-8">
                <h2 class="text-3xl font-bold primary-text border-b pb-2">Submit a New WhatsApp Channel</h2>
                <form id="channel-form" class="space-y-4 p-4 border border-gray-200 rounded-lg">

                    <!-- Channel Name -->
                    <div>
                        <label for="channel-name" class="block text-sm font-medium text-gray-700">Channel Name</label>
                        <input type="text" id="channel-name" required placeholder="e.g., Daily Tech News" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 input-focus">
                    </div>

                    <!-- Channel Link -->
                    <div>
                        <label for="channel-link" class="block text-sm font-medium text-gray-700">Channel Link (Full URL)</label>
                        <input type="url" id="channel-link" required placeholder="https://whatsapp.com/channel/..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 input-focus">
                    </div>

                    <!-- Channel Details / Description -->
                    <div>
                        <label for="channel-details" class="block text-sm font-medium text-gray-700">Channel Details (Short Description)</label>
                        <textarea id="channel-details" rows="3" required placeholder="Describe the channel's purpose and content in brief." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 input-focus"></textarea>
                    </div>

                    <!-- Channel Category -->
                    <div>
                        <label for="channel-category" class="block text-sm font-medium text-gray-700">Select Category</label>
                        <select id="channel-category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 input-focus appearance-none bg-white">
                            <option value="" disabled selected>--- Select Category ---</option>
                            <option value="news">News</option>
                            <option value="sports">Sports</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="tech">Technology</option>
                            <option value="finance">Finance & Business</option>
                            <option value="lifestyle">Lifestyle & Health</option>
                            <option value="education">Education</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-md shadow-md text-lg font-medium text-white accent-bg hover:bg-emerald-600 transition duration-150">
                        Submit Channel for Review
                    </button>
                </form>

                <!-- Published Channels List -->
                <h2 class="text-3xl font-bold primary-text border-b pb-2 pt-6 mt-8">Approved Channels</h2>
                <div id="published-channels-list" class="space-y-4">
                    <!-- Approved channels will load here -->
                    <p class="text-center text-gray-500">Approved Channels loading...</p>
                </div>
            </div>

            <!-- Admin Dashboard View -->
            <div id="admin-dashboard-view" class="hidden">
                <h2 class="text-3xl font-bold text-red-600 border-b pb-2 mb-6">Admin Dashboard (Pending Appeals)</h2>
                <!-- Button to navigate back to #submission -->
                <a href="#submission" class="inline-block text-sm font-semibold text-white px-3 py-2 rounded-md bg-gray-500 hover:bg-gray-600 transition duration-150 mb-4">
                    ‚Üê Go Back to Submission View
                </a>
                <div id="pending-appeals-list" class="space-y-4">
                    <!-- Pending submissions will load here -->
                    <p class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg">No pending appeals.</p>
                </div>
            </div>

            <!-- Custom Alert Message Box (same as before) -->
            <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <h3 id="message-title" class="text-lg font-bold mb-3">Message</h3>
                    <p id="message-text" class="mb-4 text-gray-700"></p>
                    <button id="message-close" class="w-full py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Footer -->
    <footer class="primary-bg text-white mt-8 py-4 text-center w-full">
        <p class="text-sm">&copy; 2024 Channel Review Studio. All rights reserved.</p>
    </footer>

    <!-- Firebase SDK Imports (Logic Updated for Hash Routing) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization Variables ---
        let app;
        let db;
        let auth;
        let userId = null;
        let isAdmin = false;

        // Hardcoded admin UID mechanism for this prototype: 
        // The first user who logs in sets the ADMIN_UID in localStorage.
        const ADMIN_UID_KEY = 'admin_uid_for_app'; 
        let ADMIN_UID = localStorage.getItem(ADMIN_UID_KEY);

        // Firestore Path Variables
        const PUBLIC_PATH = `artifacts/${appId}/public/data/`;
        const PENDING_COLLECTION = `${PUBLIC_PATH}pending_channels`;
        const PUBLISHED_COLLECTION = `${PUBLIC_PATH}published_channels`;

        // --- Utility Functions ---

        // Custom Alert Function (To avoid using window.alert())
        function showMessage(title, message) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
            document.getElementById('message-close').onclick = () => {
                document.getElementById('message-box').classList.add('hidden');
                document.getElementById('message-box').classList.remove('flex');
            };
        }

        // --- View Switching Logic (Now controls the hash too) ---

        // This function reads the hash and displays the correct view
        function routeByHash() {
            const hash = window.location.hash || '#submission';
            
            // Default to submission view
            document.getElementById('submission-view').classList.remove('hidden');
            document.getElementById('admin-dashboard-view').classList.add('hidden');

            if (hash === '#admin') {
                if (isAdmin) {
                    // Show admin view if hash is #admin AND user is admin
                    document.getElementById('submission-view').classList.add('hidden');
                    document.getElementById('admin-dashboard-view').classList.remove('hidden');
                    // Hide the Admin button link when already on the dashboard
                    document.getElementById('admin-link-btn').classList.add('hidden');
                } else {
                    // If a non-admin tries to access #admin, redirect them to #submission
                    showMessage("Access Denied", "You do not have administrative privileges to view this page.");
                    window.location.hash = 'submission';
                }
            } else if (hash === '#submission') {
                // If on submission view, ensure admin button is visible if admin
                if (isAdmin) {
                    document.getElementById('admin-link-btn').classList.remove('hidden');
                }
            }
        }

        // Add event listener for when the hash changes (e.g., back/forward buttons)
        window.addEventListener('hashchange', routeByHash);


        // --- Firebase Setup and Authentication ---
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // Set the first authenticated user as the admin for this demo
                        if (!ADMIN_UID) {
                            ADMIN_UID = userId;
                            localStorage.setItem(ADMIN_UID_KEY, ADMIN_UID);
                            console.log("SUCCESS: Current user set as Admin for this app.");
                        }

                        isAdmin = (userId === ADMIN_UID);
                        
                        document.getElementById('user-info').innerHTML = `
                            Your Status: <span class="font-semibold text-green-600">Authenticated</span>. 
                            UserID: <span class="text-xs break-all">${userId}</span>
                            ${isAdmin ? '<span class="text-red-600 font-bold">(ADMIN)</span>' : ''}
                        `;
                        
                        if (isAdmin) {
                            // Set up the listener for pending appeals
                            setupPendingListener();
                        }

                        // Set up the listener for published channels
                        setupPublishedListener();

                        // IMPORTANT: Now that isAdmin is set, route the user based on the initial hash
                        routeByHash();

                    } else {
                        // User logged out/not authenticated
                        userId = null;
                        isAdmin = false;
                        document.getElementById('user-info').innerHTML = `Your Status: <span class="font-semibold text-red-600">Not Authenticated</span>.`;
                        document.getElementById('admin-link-btn').classList.add('hidden');
                        routeByHash(); // Route to submission if not logged in
                    }
                });

                // Initial sign-in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage("Error", "Could not initialize Firebase. Check console for details.");
            }
        } else {
            showMessage("Database Error", "Firebase configuration is missing. The application will not function.");
        }


        // --- Channel Submission Logic and Admin Action Logic remain the same ---

        document.getElementById('channel-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId) {
                showMessage("Authentication Required", "You must be authenticated to submit data. Please wait a moment for authentication to complete.");
                return;
            }

            const channelName = document.getElementById('channel-name').value.trim();
            const channelLink = document.getElementById('channel-link').value.trim();
            const channelDetails = document.getElementById('channel-details').value.trim();
            const channelCategory = document.getElementById('channel-category').value;

            if (!channelName || !channelLink || !channelDetails || !channelCategory) {
                 showMessage("Required Information", "Please fill in all fields.");
                 return;
            }

            const newChannel = {
                name: channelName,
                link: channelLink,
                details: channelDetails,
                category: channelCategory,
                submittedBy: userId,
                submittedAt: new Date().toISOString()
            };

            try {
                // Add the channel to the pending collection
                await addDoc(collection(db, PENDING_COLLECTION), newChannel);

                showMessage("Submission Successful!", 
                    "Your channel has been sent for review. It will appear in the public list once approved by the admin."
                );

                // Reset the form
                document.getElementById('channel-form').reset();

            } catch (error) {
                console.error("Submission Error:", error);
                showMessage("Submission Error", `The channel could not be submitted. Error: ${error.message}`);
            }
        });

        window.handleAdminAction = async function(docId, action) {
            if (!isAdmin) {
                showMessage("Permission Denied", "You do not have permission to perform this action.");
                return;
            }

            const docRef = doc(db, PENDING_COLLECTION, docId);

            try {
                if (action === 'approve') {
                    // Fetch the pending document
                    const pendingDoc = await getDoc(docRef);
                    if (pendingDoc.exists()) {
                        const data = pendingDoc.data();
                        
                        // Copy to Published collection
                        await setDoc(doc(db, PUBLISHED_COLLECTION, docId), {
                            ...data,
                            approvedBy: userId,
                            approvedAt: new Date().toISOString(),
                            status: 'approved'
                        });

                        // Delete from Pending collection
                        await deleteDoc(docRef);
                        showMessage("Approved", `Channel '${data.name}' has been successfully approved and uploaded to the public list.`);

                    } else {
                         showMessage("Error", "This appeal has already been approved or rejected.");
                    }
                } else if (action === 'reject') {
                    // Delete from Pending collection
                    await deleteDoc(docRef);
                    showMessage("Appeal Rejected", "Channel submission has been rejected.");
                }
            } catch (error) {
                console.error("Admin Action Error:", error);
                showMessage("Action Error", `The action could not be completed. Error: ${error.message}`);
            }
        }


        // --- Listeners for Realtime Data remain the same ---

        // Pending Channels Listener (Admin Only)
        function setupPendingListener() {
            if (!db || !ADMIN_UID) return;

            const q = query(collection(db, PENDING_COLLECTION));
            
            onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('pending-appeals-list');
                listContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg">There are no pending appeals.</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    
                    const appealElement = `
                        <div class="border p-4 rounded-lg shadow-md bg-white space-y-2 border-l-4 border-red-500">
                            <h3 class="text-xl font-bold text-gray-800">${data.name}</h3>
                            <p class="text-sm text-gray-600">Link: <a href="${data.link}" target="_blank" class="text-blue-500 hover:underline break-all">${data.link}</a></p>
                            <p class="text-sm text-gray-60
